<div class="min-h-screen bg-gray-100 p-2">
  <h1 class="text-2xl font-semibold text-center mb-3 text-blue-600">
    EDI File Generator
  </h1>

  <!-- Split Layout Container -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 max-w-[1800px] mx-auto">
    
    <!-- Left Side - Form -->
    <div class="bg-gray-50 rounded-lg shadow-sm p-2 overflow-y-auto" style="max-height: calc(100vh - 80px);" [formGroup]="ediFormGroup">

  <!-- Transaction Settings -->
  <div class="bg-white rounded-lg shadow-sm mb-3 overflow-hidden border border-gray-200">
    <button 
      type="button"
      class="w-full bg-gradient-to-r from-indigo-50 to-indigo-100 p-2 cursor-pointer hover:from-indigo-100 hover:to-indigo-200 transition-all border-b border-indigo-200 focus:ring-2 focus:ring-indigo-300 focus:outline-none"
      (click)="toggleSection('transaction')"
      [attr.aria-expanded]="isSectionExpanded('transaction')"
      aria-controls="transaction-content">
      <div class="flex items-center gap-2">
        <span class="text-indigo-600 text-base font-bold" aria-hidden="true">{{ isSectionExpanded('transaction') ? '−' : '+' }}</span>
        <h2 class="text-base font-semibold text-indigo-700">Transaction Settings</h2>
      </div>
    </button>
    <div *ngIf="isSectionExpanded('transaction')" id="transaction-content" class="p-3" role="region" aria-labelledby="transaction-heading">
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label for="transactionType" class="block text-xs font-semibold text-gray-700 mb-1">Transaction Type</label>
          <select 
            id="transactionType"
            formControlName="transactionType"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
            <option value="837">837 (Claim)</option>
            <option value="835">835 (Remittance)</option>
          </select>
        </div>
        <div>
          <label for="delimiter" class="block text-xs font-semibold text-gray-700 mb-1">Delimiter</label>
          <input 
            id="delimiter"
            formControlName="delimiter"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" />
        </div>
      </div>
    </div>
  </div>

  <!-- Payer Info -->
  <div class="bg-white rounded-lg shadow-sm mb-3 overflow-hidden border border-gray-200">
    <button 
      type="button"
      class="w-full bg-gradient-to-r from-cyan-50 to-cyan-100 p-2 cursor-pointer hover:from-cyan-100 hover:to-cyan-200 transition-all border-b border-cyan-200 focus:ring-2 focus:ring-cyan-300 focus:outline-none"
      (click)="toggleSection('payer')"
      [attr.aria-expanded]="isSectionExpanded('payer')"
      aria-controls="payer-content">
      <div class="flex items-center gap-2">
        <span class="text-cyan-600 text-base font-bold" aria-hidden="true">{{ isSectionExpanded('payer') ? '−' : '+' }}</span>
        <h2 class="text-base font-semibold text-cyan-700">Payer Details</h2>
      </div>
    </button>
    <div *ngIf="isSectionExpanded('payer')" id="payer-content" class="p-3" role="region" aria-labelledby="payer-heading">
      <div formGroupName="insurance" class="grid md:grid-cols-2 gap-3">
        <div>
          <label for="payerId" class="block text-xs font-semibold text-gray-700 mb-1">Payer ID</label>
          <input 
            id="payerId"
            formControlName="payerId"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all" />
        </div>
        <div>
          <label for="planName" class="block text-xs font-semibold text-gray-700 mb-1">Plan Name</label>
          <input 
            id="planName"
            formControlName="planName"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all" />
        </div>
      </div>
    </div>
  </div>

  <!-- Patients info -->
  <div class="bg-white rounded-lg shadow-sm mb-3 overflow-hidden border border-gray-200">
    <div class="bg-gradient-to-r from-pink-50 to-pink-100 p-2 cursor-pointer hover:from-pink-100 hover:to-pink-200 transition-all border-b border-pink-200"
         (click)="toggleSection('patient')">
      <div class="flex items-center gap-2">
        <span class="text-pink-600 text-base font-bold">{{ isSectionExpanded('patient') ? '−' : '+' }}</span>
        <h2 class="text-base font-semibold text-pink-700">Patient Details</h2>
      </div>
    </div>
    <div *ngIf="isSectionExpanded('patient')" class="p-3">
      <div formGroupName="patient" class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Last Name</label>
          <input formControlName="lastName"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">First Name</label>
          <input formControlName="firstName"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Middle Name</label>
          <input formControlName="middleName"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Date of Birth</label>
          <input formControlName="dob" type="date"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" />
        </div>
      </div>
    </div>
  </div>


  <!-- Provider Info -->
  <div class="bg-white rounded-lg shadow-sm mb-3 overflow-hidden border border-gray-200">
    <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-2 cursor-pointer hover:from-orange-100 hover:to-orange-200 transition-all border-b border-orange-200"
         (click)="toggleSection('provider')">
      <div class="flex items-center gap-2">
        <span class="text-orange-600 text-base font-bold">{{ isSectionExpanded('provider') ? '−' : '+' }}</span>
        <h2 class="text-base font-semibold text-orange-700">Provider Details</h2>
      </div>
    </div>
    <div *ngIf="isSectionExpanded('provider')" class="p-3">
      <div formGroupName="provider" class="grid md:grid-cols-3 gap-3">
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">NPI</label>
          <input formControlName="npi"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Name</label>
          <input formControlName="name"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Address</label>
          <input formControlName="address"
            class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" />
        </div>
      </div>
    </div>
  </div>


  <!-- Claims Section Header -->
  <div class="mb-3">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-bold text-gray-800">Claims</h2>
      <button 
        (click)="addClaim()" 
        type="button"
        aria-label="Add new claim"
        class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 font-medium transition-all shadow-sm focus:ring-2 focus:ring-blue-300 focus:outline-none">
        + Add Claim
      </button>
    </div>
  </div>

  <!-- Claims Array -->
  <div formArrayName="claims" class="space-y-3 mb-3">
    <div *ngFor="let claim of claims.controls; let claimIndex = index" [formGroupName]="claimIndex"
      class="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">
      
      <!-- Claim Header - Collapsible -->
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-2 border-b border-blue-200">
        <div class="flex items-center justify-between">
          <button 
            type="button"
            class="flex items-center gap-2 hover:opacity-80 transition-opacity focus:ring-2 focus:ring-blue-500 focus:outline-none rounded px-1 py-0.5" 
            (click)="toggleClaim(claimIndex)"
            [attr.aria-expanded]="isClaimExpanded(claimIndex)"
            [attr.aria-controls]="'claim-content-' + claimIndex"
            [attr.aria-label]="'Toggle claim ' + (claimIndex + 1)">
            <span class="text-blue-600 text-base font-bold" aria-hidden="true">{{ isClaimExpanded(claimIndex) ? '−' : '+' }}</span>
            <h2 class="text-base font-semibold text-blue-700">Claim {{claimIndex + 1}}</h2>
          </button>
          <div class="flex gap-1.5">
            <button 
              (click)="addServiceLine(claimIndex)" 
              type="button"
              aria-label="Add service line to claim"
              title="Add service line to this claim"
              class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 font-medium transition-colors shadow-sm focus:ring-2 focus:ring-blue-300 focus:outline-none">
              + Service
            </button>
            <button 
              (click)="duplicateClaim(claimIndex)" 
              type="button"
              aria-label="Duplicate this claim"
              title="Duplicate this claim with all service lines"
              class="px-2 py-1 text-xs bg-indigo-500 text-white rounded hover:bg-indigo-600 font-medium transition-colors shadow-sm focus:ring-2 focus:ring-indigo-300 focus:outline-none">
              ⎘
            </button>
            <button 
              (click)="removeClaim(claimIndex)" 
              type="button"
              *ngIf="claims.length > 1"
              aria-label="Remove this claim"
              title="Remove this claim"
              class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 font-medium transition-colors shadow-sm focus:ring-2 focus:ring-red-300 focus:outline-none">
              ✕
            </button>
          </div>
        </div>
      </div>

      <!-- Claim Content -->
      <div *ngIf="isClaimExpanded(claimIndex)" [attr.id]="'claim-content-' + claimIndex" class="p-3" role="region" [attr.aria-labelledby]="'claim-heading-' + claimIndex">
        <div class="grid md:grid-cols-3 gap-2 mb-3 bg-gray-50 p-2 rounded border border-gray-200">
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1">Claim Status</label>
            <input formControlName="claimStatus"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1">Claim Number</label>
            <input formControlName="claimNumber"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1">Total Charge</label>
            <input formControlName="totalCharge"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1">Paid Amount</label>
            <input formControlName="payment"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1">Adjustment</label>
            <input formControlName="adjustment"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-700 mb-1">Service Date</label>
            <input formControlName="serviceDate" type="date"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
          </div>
        </div>

        <!-- Dynamic Service Lines -->
        <div formArrayName="serviceLines" class="space-y-2">
          <div *ngFor="let line of getServiceLines(claimIndex).controls; let serviceIndex = index" [formGroupName]="serviceIndex"
            class="border border-gray-200 rounded overflow-hidden bg-white shadow-sm">
            
            <!-- Service Line Header - Collapsible -->
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-1.5 cursor-pointer hover:from-purple-100 hover:to-purple-200 transition-all border-b border-purple-200"
                 (click)="toggleServiceLine(claimIndex, serviceIndex)">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-1.5">
                  <span class="text-purple-600 text-sm font-bold">{{ isServiceLineExpanded(claimIndex, serviceIndex) ? '−' : '+' }}</span>
                  <h3 class="text-sm font-semibold text-purple-700">Service Line {{serviceIndex + 1}}</h3>
                </div>
                <div class="flex gap-1">
                  <button (click)="duplicateServiceLine(claimIndex, serviceIndex); $event.stopPropagation()" type="button"
                    title="Duplicate this service line with adjustments"
                    class="px-2 py-0.5 text-xs bg-indigo-500 text-white rounded hover:bg-indigo-600 font-medium transition-colors shadow-sm">
                    ⎘
                  </button>
                  <button (click)="removeServiceLine(claimIndex, serviceIndex); $event.stopPropagation()" type="button"
                    title="Remove this service line"
                    class="px-2 py-0.5 text-xs bg-red-500 text-white rounded hover:bg-red-600 font-medium transition-colors shadow-sm">
                    ✕
                  </button>
                </div>
              </div>
            </div>

            <!-- Service Line Content -->
            <div *ngIf="isServiceLineExpanded(claimIndex, serviceIndex)" class="p-2">
              <div class="grid md:grid-cols-3 gap-1.5 mb-2 bg-gray-50 p-1.5 rounded border border-gray-200">
                <div>
                  <label class="block text-xs font-semibold text-gray-700 mb-0.5">Procedure</label>
                  <input formControlName="procedureCode" placeholder="99213"
                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500 transition-all" />
                </div>
                <div>
                  <label class="block text-xs font-semibold text-gray-700 mb-0.5">Diagnosis</label>
                  <input formControlName="diagnosisCode" placeholder="M25.561"
                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500 transition-all" />
                </div>
                <div>
                  <label class="block text-xs font-semibold text-gray-700 mb-0.5">Charge</label>
                  <input formControlName="chargeAmount" placeholder="0.00"
                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500 transition-all" />
                </div>
                <div>
                  <label class="block text-xs font-semibold text-gray-700 mb-0.5">Paid</label>
                  <input formControlName="paidAmount" placeholder="0.00"
                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500 transition-all" />
                </div>
                <div>
                  <label class="block text-xs font-semibold text-gray-700 mb-0.5">Adjustment</label>
                  <input formControlName="adjustmentAmount" placeholder="0.00"
                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500 transition-all" />
                </div>
                <div>
                  <label class="block text-xs font-semibold text-gray-700 mb-0.5">Date</label>
                  <input formControlName="serviceDate" type="date"
                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-purple-500 transition-all" />
                </div>
              </div>

              <!-- Adjustments Section - Collapsible -->
              <div class="mt-2 border border-gray-200 rounded overflow-hidden">
                <div class="bg-gradient-to-r from-green-50 to-green-100 p-1.5 cursor-pointer hover:from-green-100 hover:to-green-200 transition-all border-b border-green-200"
                     (click)="toggleAdjustments(claimIndex, serviceIndex)">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-1.5">
                      <span class="text-green-600 text-xs font-bold">{{ isAdjustmentsExpanded(claimIndex, serviceIndex) ? '−' : '+' }}</span>
                      <h4 class="text-xs font-semibold text-green-700">Adjustments ({{getAdjustments(claimIndex, serviceIndex).length}})</h4>
                    </div>
                    <button (click)="addAdjustment(claimIndex, serviceIndex); $event.stopPropagation()" type="button"
                      title="Add adjustment to this service line"
                      class="px-2 py-0.5 text-xs bg-green-500 text-white rounded hover:bg-green-600 font-medium transition-colors shadow-sm">
                      + Add
                    </button>
                  </div>
                </div>

                <!-- Adjustments Content -->
                <div *ngIf="isAdjustmentsExpanded(claimIndex, serviceIndex)" class="p-1.5 bg-gray-50">
                  <div formArrayName="claimAdjustments" class="space-y-1.5">
                    <div *ngFor="let adj of getAdjustments(claimIndex, serviceIndex).controls; let adjIndex = index" [formGroupName]="adjIndex"
                      class="border border-gray-200 rounded p-2 bg-white">
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs font-semibold text-gray-700">Adj {{adjIndex + 1}}</span>
                        <div class="flex gap-1">
                          <button (click)="duplicateAdjustment(claimIndex, serviceIndex, adjIndex)" type="button"
                            title="Duplicate this adjustment"
                            class="text-xs px-1.5 py-0.5 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition-colors">
                            ⎘
                          </button>
                          <button (click)="removeAdjustment(claimIndex, serviceIndex, adjIndex)" type="button"
                            title="Remove this adjustment"
                            class="text-xs px-1.5 py-0.5 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                            ✕
                          </button>
                        </div>
                      </div>
                      <div class="grid md:grid-cols-2 gap-1.5">
                        <div>
                          <label class="block text-xs font-semibold text-gray-700 mb-0.5">Code</label>
                          <input formControlName="adjustmentCode" placeholder="CO-45"
                            class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-green-500 focus:border-green-500 transition-all" />
                        </div>
                        <div>
                          <label class="block text-xs font-semibold text-gray-700 mb-0.5">Amount</label>
                          <input formControlName="adjustmentAmount" placeholder="0.00"
                            class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-green-500 focus:border-green-500 transition-all" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

      <!-- Action Buttons -->
      <div class="text-center mt-3">
        <div class="flex justify-center gap-2">
          <button 
            (click)="resetForm()" 
            type="button"
            aria-label="Reset form to default values"
            title="Clear all form data and reset to defaults"
            class="px-4 py-2 bg-gray-600 text-white text-sm font-semibold rounded hover:bg-gray-700 shadow-sm transition-all focus:ring-2 focus:ring-gray-300 focus:outline-none">
            ↻ Reset
          </button>
          <button 
            (click)="generateEDI()" 
            type="button"
            aria-label="Generate EDI file from form data"
            title="Generate EDI 835 file from the form data"
            class="px-6 py-2 bg-green-600 text-white text-sm font-semibold rounded hover:bg-green-700 shadow-sm transition-all focus:ring-2 focus:ring-green-300 focus:outline-none">
            ✓ Generate EDI
          </button>
        </div>
      </div>
    </div>

    <!-- Right Side - EDI Preview -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col" style="max-height: calc(100vh - 80px);">
      <!-- Preview Header -->
      <div class="bg-gradient-to-r from-slate-50 to-slate-100 p-2 border-b border-slate-200">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold text-slate-700">EDI Preview</h2>
          <div class="flex gap-1.5">
            <button 
              (click)="copyToClipboard()"
              [disabled]="!ediContent()"
              type="button"
              [attr.aria-label]="copySuccess() ? 'EDI content copied to clipboard' : 'Copy EDI content to clipboard'"
              [attr.title]="copySuccess() ? 'EDI content copied!' : 'Copy EDI content to clipboard'"
              class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium transition-colors shadow-sm flex items-center gap-1.5 focus:ring-2 focus:ring-blue-300 focus:outline-none">
              <span>{{ copySuccess() ? '✓ Copied!' : 'Copy' }}</span>
            </button>
            <button 
              (click)="clearPreview()"
              [disabled]="!ediContent()"
              type="button"
              aria-label="Clear EDI preview content"
              title="Clear the EDI preview panel"
              class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed font-medium transition-colors shadow-sm focus:ring-2 focus:ring-red-300 focus:outline-none">
              Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Preview Content -->
      <div class="flex-1 overflow-y-auto p-2">
        @if (isLoading()) {
          <div class="flex items-center justify-center h-full">
            <div class="text-center">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
              <p class="text-sm text-gray-600">Generating...</p>
            </div>
          </div>
        } @else if (ediContent()) {
          <pre class="bg-gray-50 p-2 rounded border border-gray-200 text-xs font-mono whitespace-pre-wrap break-all overflow-x-auto">{{ ediContent() }}</pre>
        } @else {
          <div class="flex items-center justify-center h-full">
            <div class="text-center text-gray-400">
              <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <p class="text-sm font-medium">No EDI content yet</p>
              <p class="text-xs mt-1">Fill out the form and click "Generate EDI"</p>
            </div>
          </div>
        }
      </div>

      <!-- Preview Footer with Stats -->
      @if (ediContent()) {
        <div class="bg-gray-50 p-3 border-t border-gray-200">
          <div class="flex items-center justify-between text-sm text-gray-600">
            <span>Characters: {{ ediContent().length }}</span>
            <span>Lines: {{ ediContent().split('\n').length }}</span>
          </div>
        </div>
      }
    </div>

  </div>
</div>